---
title: "Analysis 1: Filtering Analysis"
author: "Joe Gunn"
date: "2022-07-28"
output: html_document
---

# Project: Effects of admixture on fitness in Neosho Bass populations 
<font size="+1">We assessed the effect of admixture on fitness in two stream populations within the native range of the Neosho Bass (<i>M. velox</i>) which are known to have extensively hybridized with Smallmouth Bass (<i>Micropterus dolomieu</i>). Specifically, we used 14 microsatellite loci in a Bayesian analysis of population structure to estimate proportions of interspecific ancestry in individuals collected from Big Sugar Creek and the Elk River in southwestern Missouri (Central Interior Highlands ecoregion (CIH), North America). We used ancestry inference to identify fish as "Pure Neosho Bass", "Pure Smallmouth Bass", or "Admixed". For each group, we measured age and total length and projected individual growth using the standard parameterization of the von Berlanffy growth model, comparing average theoretical maximum length among groups. Finally, we used calculated a body condition as a proxy of fitness and generated heterozygosity-fitness correlations of body condition across the global dataset, within stream populations, and within ancestry groups. We ultimately sought to understand the short-term genetic consequences of admixture for Neosho Bass populations in order to better inform management and long-term viability of distinct, economically and ecologically important sportfish species in the CIH.</font>

## Specific Aim: Data preparation, enumeration, and filtering
For this aim, we clean, filter, and summarize the full genotype data (14 microsatellite loci) and phenotypic data (consensus age and total length) for our raw samples, which were fish collected from two streams (Big Sugar Creek and Elk River) within the recognized native range of the Neosho Bass (<i>M. velox</i>). We also clean and filter the full genotype data for a reference set of samples representing Smallmouth Bass (<i>M. dolomieu</i>) collected from streams in the White River drainage in the Smallmouth Bass native range. We did not collect phenotypic data on the Smallmouth Bass reference samples.

## Phases of Analysis
### Phase 1: Data read-in and preparation
### Phase 2: Data filtering and enumeration

## Libraries needed for analysis
```{r setup, include=FALSE, include = FALSE}
library(readxl)
library(tidyverse)
library(cowplot)
library(devtools)
library(pophelper)
library(genepopedit)
```

## PHASE 1: DATA READ-IN AND PREPARATION

### STEP 1: Read in metadata for samples (all fish collected from the Neosho Bass range) and references (all fish collected from the Smallmouth Bass range)
In this step, we read in previously curated metadata files for the sample set of fish collected from two streams within the Neosho Bass native range (`../raw_data/sample_metadata.xlsx`) and for the reference set of fish collected from three streams within the Smallmouth Bass native range (`../raw_data/reference_metadata.xlsx`). We manipulate, clean and enumerate the dataset, and fully summarize all samples in STEP 4 below.

#### 1a. Read in and clean sample metadata; run the Rmd chunk below.

##### Read in and clean sample metadata:
```{r}
# Read in sample metadata
sample_metadata <- read_excel("../raw_data/sample_metadata.xlsx") 

# Convert characters to factors
sample_metadata <- sample_metadata %>%
  mutate(sample_id = factor(sample_id)) %>%
  mutate(river_code = factor(river_code)) %>%
  mutate(sample_number = as.numeric(sample_number)) %>%
  mutate(easting = as.numeric(easting)) %>%
  mutate(northing = as.numeric(northing)) %>%
  mutate(range_id = factor(range_id)) %>%
  mutate(river = factor(river)) %>%
  mutate(population = factor(population))
```

#### 1b. Read in and clean reference metadata; run the Rmd chunk below.

##### Read in and clean reference metadata:
```{r}
# Read in reference metadata
reference_metadata <- read_excel("../raw_data/reference_metadata.xlsx") 

# Convert characters to factors
reference_metadata <- reference_metadata %>%
  mutate(sample_id = factor(sample_id)) %>%
  mutate(river_code = factor(river_code)) %>%
  mutate(sample_number = as.numeric(sample_number)) %>%
  mutate(easting = as.numeric(easting)) %>%
  mutate(northing = as.numeric(northing)) %>%
  mutate(range_id = factor(range_id)) %>%
  mutate(river = factor(river)) %>%
  mutate(population = factor(population))
```

#### 1c. Concatenate sample and reference metadata; run the Rmd chunk below.

##### Read in and clean reference metadata:
```{r}
# Rbind sample and reference metadata
metadata <- rbind(sample_metadata, 
                  reference_metadata)

# Save metadata in processed raw data directory in the filtering analysis
save(metadata, file = "data/processed_raw_data/metadata.Rda")
```
#### 1d. Enumerate full metadata with samples and reference; run the Rmd chunk below.

##### Read in and clean reference metadata:
```{r}
# Load in metadata to enumerate
load("data/processed_raw_data/metadata.Rda")

# Get full sample number (N = 136)
metadata %>% count()

# Get sample size of sample (N = 116) and reference (N = 20) sets
metadata %>%
  group_by(population) %>%
  count()
  
# Get sample size by stream of origin
metadata %>%
  group_by(population, 
           river) %>%
  count()
```

<b>Data summary:</b> <br>
<i>N</i><sub>(total)</sub> = 136 <br>
<i>N</i><sub>(sample_set)</sub> = 116 <br>
<i>N</i><sub>(reference_set)</sub> = 20 <br>
<i>N</i><sub>(sample_elk)</sub> = 70 <br>
<i>N</i><sub>(sample_bigsugar)</sub> = 46 <br>

### STEP 2: Read in genotype data for all samples and references (one single genotype file)
In this step, we read in genotype data for all fish included in the study, including samples (collected from the Neosho Bass native range) and references (collected from the Smallmouth Bass native range). These genotype data were derived from multiplex PCR (see `../project_info/msat_primer_info/msat_primer_info.docx` for microsatellite primer oligonucleotide flanking sequences and corresponding metadata, including literature references) followed by and fragment analysis and subsequent allele scoring in GeneMarker (Soft Genetics). We manipulate, clean and enumerate the dataset, and fully summarize all samples in STEP 4 below.

#### 2a. Read in, clean, and join genotype data with metadata; run the Rmd chunk below.

##### Read in and clean genotype data:
```{r}
# Read in genotype data
genotype_data <- read_excel("../raw_data/genotype_data.xlsx") 

# Convert characters to factors
genotype_data <- genotype_data %>%
  mutate(sample_id = factor(sample_id))

# Save genotype in processed raw data directory in the filtering analysis
save(genotype_data, file = "data/processed_raw_data/genotype_data.Rda")
```

#### 2b. Enumerate full genotype data; run the Rmd chunk below.

##### Read in and clean genotype data:
```{r}
# Load in genotype to enumerate
load("data/processed_raw_data/genotype_data.Rda")

# Get full sample number (N = 135)
genotype_data %>% count()
```

There was a discrepancy in the number of sample ids present in the metadata (<i>N</i> = 136) and the number present in the genotype data (<i>N</i> = 135). We therefore conducted a direct comparison of the two columns to see where they differed and to identify any sample ids without corresponding metadata and genotype data in both datasets.

##### 2b.1. Compare metadata and genotype data to resolve sample number discrepancy; run the Rmd chunk below.

##### Resolve sample number discrepancy:
```{r}
# Load in metadata
load("data/processed_raw_data/metadata.Rda")

# Load in genotype data
load("data/processed_raw_data/genotype_data.Rda")

# Resolve sample discrepancy

# Samples in metadata but not in genotype data
metadata %>% 
  filter(!metadata$sample_id %in% genotype_data$sample_id)

# Samples in genotype data but not in metadata
genotype_data %>% 
  filter(!genotype_data$sample_id %in% metadata$sample_id)
```
We found that the metadata file contained a sample (FER71) that was not represented in the genotype data. We are unsure whether we failed to genotype this fish or whether we lost the data in transition at some point. Sample FER71 was therefore not considered part of the final dataset and was removed from downstream analyses by merging the genotype, metadata, and phenotype files (see Step 4 below).

### STEP 3: Read in phenotype data data for samples
In this step, we read in phenotype data for all fish included in the study. Data include: 

   1. "sample_id": same as in metadata and genotype data
   2. "sex": male or female, determined by internal gonad examination, 
   3. "tl_alive": total length of the fish immediately upon capture by rod-and-reel, as measured from the tip of the lower mandible to the posterior tip of the caudal fin squeezed together
   4. "tl_dead": total length of the fish upon sample processesing (after approximately one month frozen)
   5. "mass_dead": mass of the fish in grams at time of sample processing
   6. "meas_ints": initials of the person doing the phenotypic measuring, measuring, or assessment, for later analysis of observer/measurement bias
   7. "eddie_age": age estimate based on sagittal otolith annuli, performed by Eddie Sterling
   8. "joe_age": age estimate performed by Joe Gunn
   9. "michael_age": age estimate performed by Michael Moore 
   10. "consensus_age": ultimate age estimate based on consensus of three agers, Eddie, Joe, and Michael
   11. "sl": standard length of the fish, as measured from the tip of the mandible to the hyperal plate, just anterior to the caudal fin
   12. "bd": body depth, as measured at the thickest part of the fish
   13. "hl": head length, as measured from the tip of the lower mandible to the posterior end of the gill plate
   14. "ol": orbital length, the diameter of the eye ball
   15. "sd_ray": the number of soft dorsal fin rays. 

Additionally, we did not collect phenotype data for the reference set (Smallmouth Bass), as these samples were used only as a reference for genetic ancestry inference in STRUCTURE in subsequent analyses. We manipulate, clean and enumerate the dataset, and fully summarize all samples in STEP 4 below.

#### 3a. Read in, clean, and join phenotype data with metadata; run the Rmd chunk below.

##### Read in and clean genotype data:
```{r}
# Read in phenotype data
phenotype_data <- read_excel("../raw_data/phenotype_data.xlsx") 

# Convert characters to factors
phenotype_data <- phenotype_data %>%
  mutate(sample_id = factor(sample_id)) %>%
  mutate(sex = factor(sex)) %>%
  mutate(tl_alive = as.numeric(tl_alive)) %>%
  mutate(tl_dead = as.numeric(tl_dead)) %>%
  mutate(mass_dead = as.numeric(mass_dead)) %>%
  mutate(meas_ints = factor(meas_ints))

# Save phenotype data in processed raw data directory in the filtering analysis
save(phenotype_data, file = "data/processed_raw_data/phenotype_data.Rda")
```

#### 3b. Enumerate full phenotype data; run the Rmd chunk below.

##### Read in and clean phenotype data:
```{r}
# Load in metadata to enumerate
load("data/processed_raw_data/phenotype_data.Rda")

## Given that we did not have phenotype data for the Smallmouth Bass reference samples, we expected a sample size here reflecting only fish caught in the Neosho Bass native range from Big Sugar Creek or the Elk River. Here, we checked to determine whether the number of samples in each stream in the Neosho range matched between the metadata (see Step 1d above)

# Get sample set number (N = 119)
phenotype_data %>% count()
```

There was a discrepancy in the number of sample ids present in the metadata for the sample set (<i>N</i> = 116) and the number present in the phenotype data (<i>N</i> = 119). We therefore conducted a direct comparison of the two columns to see where they differed and to identify any sample ids without corresponding data in both datasets.

##### 3b.1. Compare metadata and phenotype data to resolve sample number discrepancy; run the Rmd chunk below.

##### Resolve sample number discrepancy:
```{r}
# Load in metadata
load("data/processed_raw_data/metadata.Rda")

# Load in phenotype data
load("data/processed_raw_data/phenotype_data.Rda")

# Resolve sample discrepancy

# Samples in metadata but not in phenotype data
metadata %>% 
  filter(!metadata$sample_id %in% phenotype_data$sample_id)

# Samples in genotype data but not in metadata
phenotype_data %>% 
  filter(!phenotype_data$sample_id %in% metadata$sample_id)
```

Aside from the expected discrepancy in samples with the reference set (no reference samples in the phenotype data), we found that the phenotype data file contained three samples (FBS47, FBS48, FBS49) that were not represented in the metadata data. These three samples were collected at a later time compared to all other samples, and we did not take genotype data on these fish. Samples FBS47, FBS48, and FBS49 were therefore not considered part of the final dataset and were removed from downstream analyses by merging the genotype, metadata, and phenotype files (see Step 4 below).

### STEP 4: Merge all datasets (metadata, phenotype_data, genotype_data) and summarize the full datasets
In this step, we create two working datasets: 1) metadata and genotype data (`data/processed_raw_data/full_genotype_data.Rda`), and 2) metadata and phenotype_data (`data/processed_raw_data/full_phenotype_data.Rda`). These files will be used in subsequent analyses and subsetted where necessary.

#### 4a. Merge data sets; run the Rmd chunk below.

##### Merge and create full metadata and full phenotype data
```{r}
# Load in metadata
load("data/processed_raw_data/metadata.Rda")

# Load in genotype_data
load("data/processed_raw_data/genotype_data.Rda")

# Load in phenotype_data
load("data/processed_raw_data/phenotype_data.Rda")

## Full genotype data

# Get full genotype dataset
full_genotype_data <- merge(metadata, 
                   genotype_data,
                   by = "sample_id")

# Save the full genotype data
save(full_genotype_data, file = "data/processed_raw_data/full_genotype_data.Rda")

## Full phenotype data

# Get full phenotype dataset
full_phenotype_data <- merge(metadata, 
                   phenotype_data,
                   by = "sample_id")

# Omit sample FER71 from full phenotype data
full_phenotype_data <- full_phenotype_data %>%
  filter(sample_id != "FER71")

# Save the full phenotype data
save(full_phenotype_data, file = "data/processed_raw_data/full_phenotype_data.Rda")
```

#### 4b. Summarize the full datasets.
In this step, we are fully enumerating the genotype and phenotype datasets so that we know how many samples belong to each group of interest for the final manuscript.

##### 4b.1. Summarize the full genotype data set; run the Rmd chunk below:

##### Summarize full genotype data
```{r}
# Load in full genotype data
load("data/processed_raw_data/full_genotype_data.Rda")


```

##### 4b.2. Summarize the full phenotype data set; run the Rmd chunk below:

##### Summarize full phenotype data
```{r}
# Load in full phenotype data
load("data/processed_raw_data/full_phenotype_data.Rda")


```
